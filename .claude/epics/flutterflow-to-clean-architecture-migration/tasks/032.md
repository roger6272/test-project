---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P1
estimate: 6-7 hours
depends_on: [031]
week: 7
---

# Task 032: Implement Profile Feature with GDPR Export/Deletion

## Description

Create Profile feature including user profile management, GDPR data export (JSON), and GDPR account deletion. Implement domain, data, and presentation layers.

## Acceptance Criteria

- [ ] UserProfile entity created
- [ ] ProfileRepository interface created
- [ ] Use cases created (GetProfile, UpdateProfile, ExportUserData, DeleteAccount)
- [ ] GDPR data export generates JSON with all user data
- [ ] GDPR account deletion removes all Firestore data and Firebase Auth account
- [ ] ProfileBloc created
- [ ] ProfilePage created with settings
- [ ] Double confirmation for account deletion
- [ ] Profile feature tested and deployed

## Technical Details

**UserProfile Entity**:
```dart
class UserProfile extends Equatable {
  final String userId;
  final String email;
  final String? displayName;
  final DateTime createdAt;
  final DateTime lastLogin;

  const UserProfile({
    required this.userId,
    required this.email,
    this.displayName,
    required this.createdAt,
    required this.lastLogin,
  });

  @override
  List<Object?> get props => [userId, email, displayName, createdAt, lastLogin];
}
```

**ExportUserDataUseCase**:
```dart
class ExportUserDataUseCase implements UseCase<String, NoParams> {
  final ProfileRepository profileRepository;
  final ItemRepository itemRepository;
  final EventLogRepository eventLogRepository;

  @override
  Future<Either<Failure, String>> call(NoParams params) async {
    try {
      // Gather all user data
      final profileResult = await profileRepository.getProfile();
      final itemsResult = await itemRepository.getItems();
      final eventsResult = await eventLogRepository.getEventsByDateRange(
        DateTime(2020, 1, 1),
        DateTime.now(),
      );

      final Map<String, dynamic> exportData = {
        'export_date': DateTime.now().toIso8601String(),
        'profile': profileResult.fold((_) => null, (p) => {
          'user_id': p.userId,
          'email': p.email,
          'display_name': p.displayName,
          'created_at': p.createdAt.toIso8601String(),
        }),
        'items': itemsResult.fold((_) => [], (items) => items.map((item) => {
          'id': item.id,
          'name': item.name,
          'count': item.count,
          'today_count': item.todayCount,
          'created': item.lastResetTime.toIso8601String(),
        }).toList()),
        'events': eventsResult.fold((_) => [], (events) => events.map((event) => {
          'id': event.id,
          'item_id': event.itemId,
          'event_name': event.eventName,
          'increment': event.increment,
          'timestamp': event.createdTime.toIso8601String(),
        }).toList()),
      };

      final jsonString = const JsonEncoder.withIndent('  ').convert(exportData);
      return Right(jsonString);
    } catch (e) {
      return Left(ServerFailure('Failed to export data: ${e.toString()}'));
    }
  }
}
```

**DeleteAccountUseCase**:
```dart
class DeleteAccountUseCase implements UseCase<void, NoParams> {
  final ProfileRepository profileRepository;
  final ItemRepository itemRepository;
  final EventLogRepository eventLogRepository;
  final FirebaseAuth auth;
  final FirebaseFirestore firestore;

  @override
  Future<Either<Failure, void>> call(NoParams params) async {
    try {
      final userId = auth.currentUser?.uid;
      if (userId == null) {
        return const Left(AuthFailure('Not authenticated'));
      }

      // Delete all Firestore collections
      final batch = firestore.batch();

      // Delete items
      final itemsSnapshot = await firestore
          .collection('Item')
          .where('user_id', isEqualTo: userId)
          .get();
      for (var doc in itemsSnapshot.docs) {
        batch.delete(doc.reference);
      }

      // Delete events
      final eventsSnapshot = await firestore
          .collection('EventLog')
          .where('user_id', isEqualTo: userId)
          .get();
      for (var doc in eventsSnapshot.docs) {
        batch.delete(doc.reference);
      }

      // Delete profile
      batch.delete(firestore.collection('users').doc(userId));

      await batch.commit();

      // Delete Firebase Auth account
      await auth.currentUser?.delete();

      return const Right(null);
    } catch (e) {
      return Left(ServerFailure('Failed to delete account: ${e.toString()}'));
    }
  }
}
```

**ProfilePage with GDPR Features**:
```dart
class ProfilePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Profile & Settings')),
      body: ListView(
        children: [
          ListTile(
            leading: const Icon(Icons.download),
            title: const Text('Export My Data (GDPR)'),
            subtitle: const Text('Download all your data as JSON'),
            onTap: () => _exportData(context),
          ),
          ListTile(
            leading: const Icon(Icons.delete_forever, color: Colors.red),
            title: const Text('Delete Account (GDPR)', style: TextStyle(color: Colors.red)),
            subtitle: const Text('Permanently delete all data'),
            onTap: () => _showDeleteConfirmation(context),
          ),
          ListTile(
            leading: const Icon(Icons.privacy_tip),
            title: const Text('Privacy Policy'),
            onTap: () => context.push('/privacy-policy'),
          ),
          ListTile(
            leading: const Icon(Icons.logout),
            title: const Text('Sign Out'),
            onTap: () => context.read<AuthBloc>().add(SignOutEvent()),
          ),
        ],
      ),
    );
  }

  void _showDeleteConfirmation(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Account?'),
        content: const Text(
          'This will permanently delete all your data including items, events, and account. This action cannot be undone.\n\nAre you sure?'
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              _showFinalConfirmation(context);
            },
            style: TextButton.styleFrom(foregroundColor: Colors.red),
            child: const Text('Delete'),
          ),
        ],
      ),
    );
  }

  void _showFinalConfirmation(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Final Confirmation'),
        content: const Text('Type DELETE to confirm account deletion'),
        actions: [
          TextField(
            onSubmitted: (value) {
              if (value == 'DELETE') {
                Navigator.pop(context);
                context.read<ProfileBloc>().add(DeleteAccountEvent());
              }
            },
          ),
        ],
      ),
    );
  }
}
```

## Dependencies

- Task 031: Auth feature complete
- All repositories (Items, EventLog, Profile)

## Testing

Test GDPR features:
- Export data generates valid JSON
- JSON contains all user data
- Account deletion removes all Firestore documents
- Account deletion removes Firebase Auth account
- Double confirmation prevents accidental deletion

## Notes

- GDPR data export sent via Firebase Mail Extension
- Account deletion is irreversible
- Test deletion thoroughly before deployment
- Ensure all user data collections are deleted

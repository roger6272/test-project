---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P1
estimate: 3-4 hours
depends_on: [026]
week: 6
---

# Task 027: Integrate Firebase Mail Extension

## Description

Configure Firebase Mail Extension and implement email sending functionality for CSV exports. Create data source to write to `/mail` collection with CSV attachment.

## Acceptance Criteria

- [ ] Firebase Mail Extension installed and configured
- [ ] FirestoreMailDataSource created
- [ ] SendEmailWithCSVUseCase created
- [ ] Email template configured
- [ ] CSV attached as base64-encoded file
- [ ] Email delivery tested

## Technical Details

**Install Firebase Extension**:
```bash
firebase ext:install firebase/firestore-send-email
```

**Configure Extension**:
- SMTP connection: Gmail or SendGrid
- Email collection: `/mail`
- Default FROM address
- Default templates

**FirestoreMailDataSource**:
```dart
class FirestoreMailDataSourceImpl implements FirestoreMailDataSource {
  final FirebaseFirestore firestore;

  Future<void> sendEmailWithAttachment({
    required String toEmail,
    required String subject,
    required String body,
    required String csvContent,
    required String filename,
  }) async {
    try {
      final base64Csv = base64Encode(utf8.encode(csvContent));

      await firestore.collection('mail').add({
        'to': [toEmail],
        'message': {
          'subject': subject,
          'text': body,
          'html': '<p>$body</p>',
          'attachments': [
            {
              'filename': filename,
              'content': base64Csv,
              'encoding': 'base64',
            },
          ],
        },
      });
    } catch (e) {
      throw ServerException('Failed to send email: ${e.toString()}');
    }
  }
}
```

**SendEmailWithCSVUseCase**:
```dart
class SendEmailWithCSVUseCase implements UseCase<void, SendEmailParams> {
  final FirestoreMailDataSource mailDataSource;
  final GenerateCSVUseCase generateCSV;

  SendEmailWithCSVUseCase(this.mailDataSource, this.generateCSV);

  @override
  Future<Either<Failure, void>> call(SendEmailParams params) async {
    // Generate CSV
    final csvResult = await generateCSV(GenerateCSVParams(
      startDate: params.startDate,
      endDate: params.endDate,
      aggregationLevel: params.aggregationLevel,
    ));

    return csvResult.fold(
      (failure) => Left(failure),
      (csvContent) async {
        try {
          final filename = generateFilename(
            params.startDate,
            params.endDate,
            params.aggregationLevel,
          );

          await mailDataSource.sendEmailWithAttachment(
            toEmail: params.email,
            subject: 'Trackwise Data Export',
            body: 'Your Trackwise data export is attached.',
            csvContent: csvContent,
            filename: filename,
          );

          return const Right(null);
        } on ServerException catch (e) {
          return Left(ServerFailure(e.message));
        }
      },
    );
  }
}
```

## Dependencies

- Task 026: CSV generation complete
- Firebase project with Mail Extension

## Testing

Test email delivery:
- Send test export
- Check email inbox
- Verify CSV attachment
- Verify CSV contents
- Test with invalid email address
- Test with large CSV (>1MB)

## Notes

- Firebase Mail Extension processes `/mail` collection
- Emails may take 30-60 seconds to deliver
- Monitor Firestore for delivery status
- Handle SMTP failures gracefully

---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P0
estimate: 6-7 hours
depends_on: [028]
week: 6-7
---

# Task 029: Implement Auth Domain and Data Layers

## Description

Create domain and data layers for Authentication feature including Firebase Auth integration, support for email/password, Google Sign-In, and Apple Sign-In.

## Acceptance Criteria

- [ ] User entity created
- [ ] AuthRepository interface created with all methods
- [ ] 7 use cases created (SignInWithEmail, SignInWithGoogle, SignInWithApple, SignUp, SignOut, ResetPassword, WatchAuthState)
- [ ] AuthFirebaseDataSource created
- [ ] AuthRepositoryImpl created
- [ ] Google Sign-In configured
- [ ] Apple Sign-In configured (iOS)

## Technical Details

**User Entity**:
```dart
class User extends Equatable {
  final String id;
  final String email;
  final String? displayName;
  final String? photoUrl;

  const User({
    required this.id,
    required this.email,
    this.displayName,
    this.photoUrl,
  });

  @override
  List<Object?> get props => [id, email, displayName, photoUrl];
}
```

**AuthRepository Interface**:
```dart
abstract class AuthRepository {
  Future<Either<Failure, User>> signInWithEmail(String email, String password);
  Future<Either<Failure, User>> signInWithGoogle();
  Future<Either<Failure, User>> signInWithApple();
  Future<Either<Failure, User>> signUp(String email, String password);
  Future<Either<Failure, void>> signOut();
  Future<Either<Failure, void>> resetPassword(String email);
  Stream<User?> watchAuthState();
}
```

**AuthFirebaseDataSource**:
```dart
class AuthFirebaseDataSourceImpl implements AuthFirebaseDataSource {
  final FirebaseAuth auth;
  final GoogleSignIn googleSignIn;

  Future<UserModel> signInWithEmail(String email, String password) async {
    try {
      final credential = await auth.signInWithEmailAndPassword(
        email: email,
        password: password,
      );
      return UserModel.fromFirebaseUser(credential.user!);
    } on FirebaseAuthException catch (e) {
      throw AuthException(_mapFirebaseError(e.code));
    }
  }

  Future<UserModel> signInWithGoogle() async {
    try {
      final googleUser = await googleSignIn.signIn();
      if (googleUser == null) throw AuthException('Sign in cancelled');

      final googleAuth = await googleUser.authentication;
      final credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      final result = await auth.signInWithCredential(credential);
      return UserModel.fromFirebaseUser(result.user!);
    } catch (e) {
      throw AuthException('Google sign in failed: ${e.toString()}');
    }
  }

  Future<UserModel> signInWithApple() async {
    try {
      final appleProvider = AppleAuthProvider();
      final credential = await auth.signInWithProvider(appleProvider);
      return UserModel.fromFirebaseUser(credential.user!);
    } catch (e) {
      throw AuthException('Apple sign in failed: ${e.toString()}');
    }
  }

  Stream<UserModel?> watchAuthState() {
    return auth.authStateChanges().map((user) =>
        user != null ? UserModel.fromFirebaseUser(user) : null);
  }

  String _mapFirebaseError(String code) {
    switch (code) {
      case 'user-not-found':
        return 'No user found with this email';
      case 'wrong-password':
        return 'Incorrect password';
      case 'email-already-in-use':
        return 'Email already in use';
      case 'weak-password':
        return 'Password is too weak';
      default:
        return 'Authentication failed';
    }
  }
}
```

## Dependencies

- Firebase Auth configured
- Google Sign-In package
- Apple Sign-In package (iOS)

## Testing

Unit tests:
- Test all use cases with mocked repository
- Test repository with mocked data source
- Test error mapping
- Test auth state stream

## Notes

- Google Sign-In requires OAuth client IDs
- Apple Sign-In requires Apple Developer account
- Handle auth state changes for auto-login

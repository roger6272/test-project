---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P1
estimate: 4-5 hours
depends_on: [027]
week: 6
---

# Task 028: Create Export UI and Deploy

## Description

Create Export UI page with date range picker, aggregation level selector, email input, and export button. Integrate with ExportBloc and deploy feature.

## Acceptance Criteria

- [ ] ExportPage created
- [ ] DateRangePicker widget created
- [ ] AggregationLevelSelector created
- [ ] EmailInputField with validation created
- [ ] ExportBloc created (events, states, logic)
- [ ] Export flow tested end-to-end
- [ ] Deploy and verify

## Technical Details

**ExportPage**:
```dart
class ExportPage extends StatefulWidget {
  @override
  State<ExportPage> createState() => _ExportPageState();
}

class _ExportPageState extends State<ExportPage> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  DateTime _startDate = DateTime.now().subtract(const Duration(days: 30));
  DateTime _endDate = DateTime.now();
  String _aggregation = 'daily';

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => sl<ExportBloc>(),
      child: Scaffold(
        appBar: AppBar(title: const Text('Export Data')),
        body: BlocConsumer<ExportBloc, ExportState>(
          listener: (context, state) {
            if (state is ExportSuccess) {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Export sent! Check your email.')),
              );
              context.pop();
            }
            if (state is ExportError) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(state.message)),
              );
            }
          },
          builder: (context, state) {
            return Form(
              key: _formKey,
              child: ListView(
                padding: const EdgeInsets.all(16),
                children: [
                  ListTile(
                    title: const Text('Start Date'),
                    subtitle: Text(_formatDate(_startDate)),
                    trailing: const Icon(Icons.calendar_today),
                    onTap: () => _selectStartDate(context),
                  ),
                  ListTile(
                    title: const Text('End Date'),
                    subtitle: Text(_formatDate(_endDate)),
                    trailing: const Icon(Icons.calendar_today),
                    onTap: () => _selectEndDate(context),
                  ),
                  DropdownButtonFormField<String>(
                    value: _aggregation,
                    decoration: const InputDecoration(labelText: 'Aggregation'),
                    items: const [
                      DropdownMenuItem(value: 'raw', child: Text('Raw Data')),
                      DropdownMenuItem(value: 'daily', child: Text('Daily')),
                      DropdownMenuItem(value: 'weekly', child: Text('Weekly')),
                      DropdownMenuItem(value: 'monthly', child: Text('Monthly')),
                    ],
                    onChanged: (value) => setState(() => _aggregation = value!),
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _emailController,
                    decoration: const InputDecoration(labelText: 'Email Address'),
                    validator: Validators.validateEmail,
                  ),
                  const SizedBox(height: 24),
                  ElevatedButton(
                    onPressed: state is ExportInProgress ? null : _exportData,
                    child: state is ExportInProgress
                        ? const CircularProgressIndicator()
                        : const Text('Export to Email'),
                  ),
                ],
              ),
            );
          },
        ),
      ),
    );
  }

  void _exportData() {
    if (_formKey.currentState!.validate()) {
      context.read<ExportBloc>().add(ExportCSV(
        startDate: _startDate,
        endDate: _endDate,
        aggregationLevel: _aggregation,
        email: _emailController.text,
      ));
    }
  }
}
```

**ExportBloc**:
```dart
class ExportBloc extends Bloc<ExportEvent, ExportState> {
  final SendEmailWithCSVUseCase sendEmailWithCSV;

  ExportBloc({required this.sendEmailWithCSV}) : super(ExportInitial()) {
    on<ExportCSV>(_onExportCSV);
  }

  Future<void> _onExportCSV(ExportCSV event, Emitter<ExportState> emit) async {
    emit(ExportInProgress());

    final result = await sendEmailWithCSV(SendEmailParams(
      startDate: event.startDate,
      endDate: event.endDate,
      aggregationLevel: event.aggregationLevel,
      email: event.email,
    ));

    result.fold(
      (failure) => emit(ExportError(failure.message)),
      (_) => emit(ExportSuccess()),
    );
  }
}
```

## Dependencies

- Task 027: Firebase Mail Extension configured

## Testing

Test matrix:
- Export with daily aggregation
- Export with weekly aggregation
- Export with monthly aggregation
- Export with raw data
- Test with different date ranges
- Test email validation
- Verify email received
- Verify CSV contents correct

## Notes

- Show progress indicator during export
- Email delivery may take 30-60 seconds
- Inform user to check spam folder
- Test with various email providers

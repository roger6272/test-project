---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P0
estimate: 5-6 hours
depends_on: [020]
week: 4-5
---

# Task 021: Implement EventLog Domain and Data Layers

## Description

Create domain and data layers for EventLog feature to handle event ingestion from ESP32, storage in Firestore, and querying for charts and exports.

## Acceptance Criteria

- [ ] EventLog entity created with all fields
- [ ] EventLogRepository interface created
- [ ] Use cases created (GetEventsByDateRange, InsertEvents, GetEventsByItem)
- [ ] EventLogModel created with Firestore serialization
- [ ] EventLogFirestoreDataSource created
- [ ] EventLogRepositoryImpl created
- [ ] Batch insert logic implemented
- [ ] Special handling for 'switch' events (update Item.lastUpdated)

## Technical Details

**EventLog Entity**:
```dart
class EventLog extends Equatable {
  final String id;
  final DateTime createdTime;
  final String itemId;
  final String eventName;
  final int increment;
  final int currentCount;
  final String userId;

  const EventLog({
    required this.id,
    required this.createdTime,
    required this.itemId,
    required this.eventName,
    required this.increment,
    required this.currentCount,
    required this.userId,
  });

  @override
  List<Object?> get props => [id, createdTime, itemId, eventName, increment, currentCount, userId];
}
```

**Repository Interface**:
```dart
abstract class EventLogRepository {
  Future<Either<Failure, List<EventLog>>> getEventsByDateRange(
    DateTime startDate,
    DateTime endDate,
  );
  Future<Either<Failure, void>> insertEvents(List<EventLog> events);
  Future<Either<Failure, List<EventLog>>> getEventsByItem(String itemId);
  Future<Either<Failure, void>> deleteEventsForItem(String itemId);
}
```

**Use Cases**:
- GetEventsByDateRangeUseCase
- InsertEventsUseCase (batch)
- GetEventsByItemUseCase
- DeleteEventsForItemUseCase

**Data Source**:
```dart
class EventLogFirestoreDataSourceImpl implements EventLogFirestoreDataSource {
  final FirebaseFirestore firestore;

  Future<List<EventLogModel>> getEventsByDateRange(
    String userId,
    DateTime startDate,
    DateTime endDate,
  ) async {
    final snapshot = await firestore
        .collection('EventLog')
        .where('user_id', isEqualTo: userId)
        .where('createdTime', isGreaterThanOrEqualTo: startDate.millisecondsSinceEpoch)
        .where('createdTime', isLessThanOrEqualTo: endDate.millisecondsSinceEpoch)
        .orderBy('createdTime', descending: true)
        .get();

    return snapshot.docs.map((doc) => EventLogModel.fromFirestore(doc)).toList();
  }

  Future<void> insertEventsBatch(List<EventLogModel> events) async {
    final batch = firestore.batch();

    for (var event in events) {
      final docRef = firestore.collection('EventLog').doc(event.id);
      batch.set(docRef, event.toFirestore());
    }

    await batch.commit();
  }
}
```

## Dependencies

- Task 020: Bluetooth deployed (receives events from ESP32)
- Items feature (for itemId references)

## Testing

Unit tests:
- Test EventLogModel serialization
- Test data source batch insert
- Test repository with mocked data source
- Test use cases with mocked repository
- Test date range queries

## Notes

- 'switch' events don't create EventLog, only update Item.lastUpdated
- Batch inserts for performance (ESP32 sends multiple events)
- Index Firestore on user_id and createdTime for fast queries

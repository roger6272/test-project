---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P1
estimate: 3-4 hours
depends_on: [034]
week: 8
---

# Task 035: Integrate Monitoring (Crashlytics, Analytics, Performance)

## Description

Integrate Firebase monitoring tools (Crashlytics, Analytics, Performance Monitoring) to track app health, user behavior, and performance metrics in production.

## Acceptance Criteria

- [ ] Firebase Crashlytics integrated and configured
- [ ] Firebase Analytics integrated with custom events
- [ ] Firebase Performance Monitoring integrated
- [ ] Custom analytics events tracked (item_created, device_connected, etc.)
- [ ] Crash reporting tested
- [ ] Performance traces added for key operations
- [ ] User properties set for segmentation

## Technical Details

**Add to pubspec.yaml**:
```yaml
dependencies:
  firebase_crashlytics: ^3.4.0
  firebase_analytics: ^10.7.0
  firebase_performance: ^0.9.3
```

**Initialize in main.dart**:
```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();

  // Initialize Crashlytics
  FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;
  PlatformDispatcher.instance.onError = (error, stack) {
    FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
    return true;
  };

  await configureDependencies();

  runApp(MyApp());
}
```

**Analytics Service** (`core/services/analytics_service.dart`):
```dart
class AnalyticsService {
  final FirebaseAnalytics analytics;

  AnalyticsService(this.analytics);

  // Track events
  Future<void> logItemCreated(String itemId) async {
    await analytics.logEvent(
      name: 'item_created',
      parameters: {'item_id': itemId},
    );
  }

  Future<void> logDeviceConnected(String deviceId) async {
    await analytics.logEvent(
      name: 'device_connected',
      parameters: {'device_id': deviceId},
    );
  }

  Future<void> logCSVExported(String aggregationLevel) async {
    await analytics.logEvent(
      name: 'csv_exported',
      parameters: {'aggregation_level': aggregationLevel},
    );
  }

  Future<void> logAccountDeleted() async {
    await analytics.logEvent(name: 'account_deleted');
  }

  // Set user properties
  Future<void> setItemCount(int count) async {
    await analytics.setUserProperty(
      name: 'item_count',
      value: count.toString(),
    );
  }

  // Track screens
  Future<void> setCurrentScreen(String screenName) async {
    await analytics.logScreenView(screenName: screenName);
  }
}
```

**Performance Monitoring**:
```dart
class PerformanceService {
  final FirebasePerformance performance;

  PerformanceService(this.performance);

  // Trace Bluetooth operations
  Future<void> traceBluetoothConnection(
    Future<void> Function() operation,
  ) async {
    final trace = performance.newTrace('bluetooth_connection');
    await trace.start();

    try {
      await operation();
      await trace.stop();
    } catch (e) {
      await trace.stop();
      rethrow;
    }
  }

  // Trace Firestore queries
  Future<T> traceFirestoreQuery<T>(
    String queryName,
    Future<T> Function() query,
  ) async {
    final trace = performance.newTrace('firestore_$queryName');
    await trace.start();

    try {
      final result = await query();
      await trace.stop();
      return result;
    } catch (e) {
      await trace.stop();
      rethrow;
    }
  }
}
```

**Crashlytics Integration**:
```dart
// Manually log errors
try {
  // risky operation
} catch (e, stack) {
  FirebaseCrashlytics.instance.recordError(e, stack);
}

// Add custom keys for debugging
FirebaseCrashlytics.instance.setCustomKey('user_id', userId);
FirebaseCrashlytics.instance.setCustomKey('item_count', itemCount);

// Log messages
FirebaseCrashlytics.instance.log('Attempting Bluetooth connection');
```

**Analytics Events to Track**:
- `item_created`: When user creates item
- `item_updated`: When user updates item
- `item_deleted`: When user deletes item
- `device_connected`: When Bluetooth connection succeeds
- `device_disconnected`: When Bluetooth disconnects
- `csv_exported`: When user exports CSV
- `account_deleted`: When user deletes account

**User Properties**:
- `item_count`: Number of items user has
- `has_connected_device`: Whether user has connected ESP32
- `signup_method`: email, google, or apple

**Performance Traces**:
- `bluetooth_connection`: Time to connect to ESP32
- `firestore_get_items`: Time to load items
- `firestore_get_events`: Time to load events
- `csv_generation`: Time to generate CSV

## Dependencies

- Task 034: Documentation complete
- Firebase project configured

## Testing

Test monitoring:
- [ ] Trigger test crash → appears in Crashlytics
- [ ] Track test event → appears in Analytics
- [ ] Perform traced operation → appears in Performance
- [ ] Verify custom keys in crash reports
- [ ] Verify user properties set correctly

## Notes

- Crashlytics may take 5-10 minutes to show crashes
- Analytics events may take 24 hours to appear
- Performance traces show immediately in debug
- Disable Analytics in debug mode to avoid noise
- Use debug view in Firebase Analytics console

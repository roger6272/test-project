---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P1
estimate: 3-4 hours
depends_on: [015]
week: 4
---

# Task 016: Create Mock Bluetooth Service for Testing

## Description

Create a mock Bluetooth service that simulates ESP32 behavior without requiring physical hardware. This enables testing Bluetooth features during development and in CI/CD without real devices.

## Acceptance Criteria

- [ ] MockESP32BluetoothService created implementing ESP32BluetoothService
- [ ] Simulates device scanning with fake devices
- [ ] Simulates connection success/failure
- [ ] Simulates receiving events from ESP32
- [ ] Can be toggled via environment variable or build flag
- [ ] Includes realistic delays and behaviors
- [ ] Repository can use mock service in tests

## Technical Details

**MockESP32BluetoothService** (data/datasources/mock_esp32_bluetooth_service.dart):
```dart
import 'dart:async';
import 'dart:convert';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import '../../../../core/error/exceptions.dart';
import '../../../items/domain/entities/item.dart';
import 'esp32_bluetooth_service.dart';

class MockESP32BluetoothService implements ESP32BluetoothService {
  bool _isConnected = false;
  final _eventController = StreamController<Map<String, dynamic>>.broadcast();
  final _connectionController = StreamController<BluetoothConnectionState>.broadcast();

  @override
  Stream<List<ScanResult>> scanForDevices() async* {
    await Future.delayed(const Duration(seconds: 2));

    // Yield mock devices
    yield [
      // Mock scan results would go here
      // For testing purposes, return empty or mock data
    ];
  }

  @override
  Future<void> connectToDevice(String deviceId) async {
    await Future.delayed(const Duration(seconds: 1));
    _isConnected = true;
    _connectionController.add(BluetoothConnectionState.connected);
  }

  @override
  Future<void> disconnect() async {
    _isConnected = false;
    _connectionController.add(BluetoothConnectionState.disconnected);
  }

  @override
  Stream<BluetoothConnectionState> watchConnectionState(String deviceId) {
    return _connectionController.stream;
  }

  @override
  Future<void> sendItemList(List<Item> items) async {
    if (!_isConnected) {
      throw BluetoothException('Not connected');
    }
    await Future.delayed(const Duration(milliseconds: 500));
  }

  @override
  Future<void> sendTimezone(int offsetMinutes) async {
    if (!_isConnected) {
      throw BluetoothException('Not connected');
    }
    await Future.delayed(const Duration(milliseconds: 100));
  }

  @override
  Stream<Map<String, dynamic>> listenForEvents() {
    return _eventController.stream;
  }

  // Test helper: Simulate ESP32 sending an event
  void simulateEvent(String itemId, int increment) {
    _eventController.add({
      'type': 'event',
      'item_id': itemId,
      'increment': increment,
      'timestamp': DateTime.now().millisecondsSinceEpoch,
    });
  }

  void dispose() {
    _eventController.close();
    _connectionController.close();
  }
}
```

## Dependencies

- Task 015: ESP32BluetoothService interface

## Testing

Use in tests:
```dart
final mockService = MockESP32BluetoothService();
final repository = BluetoothRepositoryImpl(mockService);

// Simulate event
mockService.simulateEvent('item_123', 1);
```

## Notes

- Essential for development without ESP32 hardware
- Enables CI/CD testing
- Can simulate edge cases (connection failures, etc.)

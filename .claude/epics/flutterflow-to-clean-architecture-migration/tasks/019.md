---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P0
estimate: 4-5 hours
depends_on: [016, 017]
week: 4
---

# Task 019: Write Unit Tests for Bluetooth with Mocks

## Description

Create comprehensive unit tests for Bluetooth feature using the mock Bluetooth service. Test domain layer (use cases), data layer (repository), and presentation layer (BLoC) without requiring physical ESP32 hardware.

## Acceptance Criteria

- [ ] All Bluetooth use cases tested
- [ ] BluetoothRepositoryImpl tested with mock service
- [ ] BluetoothBloc tested with bloc_test
- [ ] Mock service tested for expected behaviors
- [ ] Stream handling tested
- [ ] Connection state transitions tested
- [ ] Test coverage â‰¥ 70% for Bluetooth feature

## Technical Details

**Use Case Tests**:
```dart
void main() {
  late ConnectDeviceUseCase useCase;
  late MockBluetoothRepository mockRepository;

  setUp(() {
    mockRepository = MockBluetoothRepository();
    useCase = ConnectDeviceUseCase(mockRepository);
  });

  test('should connect to device successfully', () async {
    when(() => mockRepository.connectDevice(any()))
        .thenAnswer((_) async => const Right(null));

    final result = await useCase(ConnectDeviceParams(deviceId: 'device_123'));

    expect(result, const Right(null));
    verify(() => mockRepository.connectDevice('device_123')).called(1);
  });
}
```

**Repository Tests with Mock Service**:
```dart
void main() {
  late BluetoothRepositoryImpl repository;
  late MockESP32BluetoothService mockService;

  setUp(() {
    mockService = MockESP32BluetoothService();
    repository = BluetoothRepositoryImpl(mockService);
  });

  test('should return devices from scan', () async {
    // Test scan functionality
  });
}
```

**BLoC Tests**:
```dart
blocTest<BluetoothBloc, BluetoothState>(
  'emits [Scanning, DevicesFound] when StartScan succeeds',
  build: () => BluetoothBloc(/* ... */),
  act: (bloc) => bloc.add(StartScan()),
  expect: () => [
    BluetoothScanning(),
    BluetoothDevicesFound([testDevice]),
  ],
);
```

## Dependencies

- Task 016: Mock Bluetooth service
- Task 017: BluetoothBloc

## Testing

Run tests:
```bash
flutter test test/features/bluetooth/
flutter test --coverage
```

## Notes

- Mock service eliminates need for ESP32 during testing
- Test stream subscriptions and cleanup
- Test connection state transitions
- Test error handling thoroughly

---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P0
estimate: 4-5 hours
depends_on: [021]
week: 5
---

# Task 022: Implement EventLog BLoC

## Description

Create EventLog BLoC to manage event loading, filtering by date range and item, and real-time event updates from ESP32 via Bluetooth.

## Acceptance Criteria

- [ ] EventsEvent classes created (LoadEvents, FilterByDateRange, FilterByItem, AddEvent)
- [ ] EventsState classes created (EventsLoading, EventsLoaded, EventsError)
- [ ] EventsBloc created with all event handlers
- [ ] Integration with BluetoothBloc for real-time events
- [ ] Date range filtering implemented
- [ ] Item filtering implemented
- [ ] BLoC registered in GetIt

## Technical Details

**EventsEvent**:
```dart
abstract class EventsEvent extends Equatable {}

class LoadEvents extends EventsEvent {
  final DateTime? startDate;
  final DateTime? endDate;
  final String? itemId;
}

class FilterByDateRange extends EventsEvent {
  final DateTime startDate;
  final DateTime endDate;
}

class FilterByItem extends EventsEvent {
  final String itemId;
}

class AddEvent extends EventsEvent {
  final EventLog event;
}
```

**EventsState**:
```dart
abstract class EventsState extends Equatable {}

class EventsLoading extends EventsState {}

class EventsLoaded extends EventsState {
  final List<EventLog> events;
  final DateTime? startDate;
  final DateTime? endDate;
  final String? itemId;
}

class EventsError extends EventsState {
  final String message;
}
```

**EventsBloc**:
```dart
class EventsBloc extends Bloc<EventsEvent, EventsState> {
  final GetEventsByDateRangeUseCase getEventsByDateRange;
  final GetEventsByItemUseCase getEventsByItem;
  final InsertEventsUseCase insertEvents;

  EventsBloc({
    required this.getEventsByDateRange,
    required this.getEventsByItem,
    required this.insertEvents,
  }) : super(EventsLoading()) {
    on<LoadEvents>(_onLoadEvents);
    on<FilterByDateRange>(_onFilterByDateRange);
    on<FilterByItem>(_onFilterByItem);
    on<AddEvent>(_onAddEvent);
  }

  Future<void> _onLoadEvents(LoadEvents event, Emitter<EventsState> emit) async {
    emit(EventsLoading());

    final result = await getEventsByDateRange(
      GetEventsByDateRangeParams(
        startDate: event.startDate ?? DateTime.now().subtract(const Duration(days: 30)),
        endDate: event.endDate ?? DateTime.now(),
      ),
    );

    result.fold(
      (failure) => emit(EventsError(failure.message)),
      (events) => emit(EventsLoaded(events, startDate: event.startDate, endDate: event.endDate)),
    );
  }

  Future<void> _onAddEvent(AddEvent event, Emitter<EventsState> emit) async {
    final currentState = state;
    if (currentState is EventsLoaded) {
      // Add event optimistically
      final updatedEvents = [event.event, ...currentState.events];
      emit(EventsLoaded(
        updatedEvents,
        startDate: currentState.startDate,
        endDate: currentState.endDate,
      ));

      // Persist to Firestore
      await insertEvents(InsertEventsParams(events: [event.event]));
    }
  }
}
```

## Dependencies

- Task 021: EventLog domain and data layers

## Testing

BLoC tests:
- Test loading events by date range
- Test filtering by item
- Test adding events in real-time
- Test error states

## Notes

- Listen to BluetoothBloc event stream and add events via AddEvent
- Optimistic updates for real-time feel
- Date range defaults to last 30 days

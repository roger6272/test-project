---
epic: flutterflow-to-clean-architecture-migration
status: backlog
priority: P1
estimate: 3-4 hours
depends_on: [032]
week: 7
---

# Task 033: Write Tests and Deploy Profile Feature

## Description

Write tests for Profile feature including GDPR data export and account deletion, and deploy. Verify all profile functionality works correctly.

## Acceptance Criteria

- [ ] Unit tests for Profile use cases
- [ ] Tests for GDPR data export (verify JSON structure)
- [ ] Tests for GDPR account deletion (verify all data removed)
- [ ] ProfileBloc tests
- [ ] Widget tests for ProfilePage
- [ ] Integration test for full deletion flow
- [ ] Test coverage ≥ 70%
- [ ] Deploy and verify

## Technical Details

**Test Matrix**:

| Test Case | Expected Result | Status |
|-----------|----------------|--------|
| Get profile | Profile data loaded | [ ] |
| Update profile | Changes persisted | [ ] |
| Export data | JSON with all user data | [ ] |
| Export via email | Email received with JSON | [ ] |
| Delete account (cancelled) | No data deleted | [ ] |
| Delete account (confirmed) | All data deleted | [ ] |
| Delete account → sign in | Account doesn't exist | [ ] |

**GDPR Export Test**:
```dart
test('should export all user data as JSON', () async {
  // arrange
  when(() => mockProfileRepository.getProfile())
      .thenAnswer((_) async => Right(testProfile));
  when(() => mockItemRepository.getItems())
      .thenAnswer((_) async => Right([testItem]));
  when(() => mockEventLogRepository.getEventsByDateRange(any(), any()))
      .thenAnswer((_) async => Right([testEvent]));

  // act
  final result = await useCase(NoParams());

  // assert
  result.fold(
    (failure) => fail('Should not fail'),
    (jsonString) {
      final json = jsonDecode(jsonString);
      expect(json['profile']['email'], testProfile.email);
      expect(json['items'].length, 1);
      expect(json['events'].length, 1);
    },
  );
});
```

**Account Deletion Test**:
```dart
test('should delete all user data and Firebase Auth account', () async {
  // arrange
  final userId = 'user_123';
  when(() => mockAuth.currentUser).thenReturn(mockUser);
  when(() => mockUser.uid).thenReturn(userId);

  // act
  final result = await useCase(NoParams());

  // assert
  expect(result, const Right(null));
  verify(() => mockFirestore.collection('Item')
      .where('user_id', isEqualTo: userId)
      .get()).called(1);
  verify(() => mockFirestore.collection('EventLog')
      .where('user_id', isEqualTo: userId)
      .get()).called(1);
  verify(() => mockUser.delete()).called(1);
});
```

## Dependencies

- Task 032: Profile feature implemented

## Testing

Manual testing:
1. Export data → verify JSON structure
2. Export via email → verify email received
3. Update profile → verify changes saved
4. Delete account (cancel) → verify no deletion
5. Delete account (confirm) → verify all data deleted
6. Try signing in with deleted account → should fail

## Notes

- Test account deletion in dev environment first
- Verify all Firestore collections are empty after deletion
- Ensure Firebase Auth account is deleted
- Test with real email for export
- Profile feature completes all core features
